name: Neon tests
on:
  workflow_dispatch:
  push:
    branches: [winarm]

permissions: 
  actions: read
  security-events: write

jobs:
   CI_test_run: 
    runs-on: windows-11-arm

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Python 3.12
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install standard tools
        run: |
          choco install gow

      - name: Prepare framework
        run: |
          "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\VsDevCmd.bat"
          cd Testing
          echo "Create missing folders"
          mkdir FullBenchmark
          mkdir Output
          mkdir GeneratedInclude
          mkdir GeneratedSource
          mkdir GeneratedIncludeBench
          mkdir GeneratedSourceBench
          mkdir build

          echo "Install missing python packages"
          pip install -r requirements.txt

          echo "Generate some missing test patterns"
          python PatternGeneration/MatrixNeon.py

          echo "Preprocess test description"
          python preprocess.py -f desc.txt -o Output.pickle
          python preprocess.py -f desc_neon.txt -o Output_neon.pickle
          python preprocess.py -f desc_f16.txt -o Output_f16.pickle

          echo "Generate missing CPP headers"
          python processTests.py -gen . -p Patterns -d Parameters -f Output.pickle -e
          python processTests.py -gen . -p Patterns -d Parameters -f Output_neon.pickle -e
          python processTests.py -gen . -p Patterns -d Parameters -f Output_f16.pickle -e

          cd build

          cmake -G "Ninja" .. 
        
#      - name: Setup tmate session
#        uses: mxschmitt/action-tmate@v3

      - name: Execute generic tests
        run: |
          bash
          cd Testing/build

          python ../processTests.py -p ../Patterns -d ../Parameters -gen .. -e -f ../Output.pickle
          ninja 
          ./test > result.txt
          python ../processResult.py --noerr -e -f ../Output.pickle -r result.txt -html > result.html 
      
      - name: Execute neon specific C tests
        run: |
          cd Testing/build

          sh ../test_neon.sh

      - name: Execute f16 C tests
        run: |
          cd Testing/build

          python ../processTests.py -p ../Patterns -d ../Parameters -gen .. -e -f ../Output_f16.pickle
          ninja 
          ./test > result_f16.txt
          python ../processResult.py --noerr -e -f ../Output_f16.pickle -r result_f16.txt -html > result_f16.html 

      - name: Upload test report
        uses: actions/upload-artifact@v4
        with:
          name: neon-test-report
          path: |
             Testing/build/result.html
             Testing/build/result_transform_neon.html
             Testing/build/result_binaryf32_neon.html
             Testing/build/result_binary_complexf32_neon.html
             Testing/build/result_binaryf16_neon.html
             Testing/build/result_binary_complexf16_neon.html
             Testing/build/result_binaryq31_neon.html
             Testing/build/result_binary_complexq31_neon.html
             Testing/build/result_binaryq15_neon.html
             Testing/build/result_binary_complexq15_neon.html
             Testing/build/result_binaryq7_neon.html
             Testing/build/result_f16.html

      
      - name: Check error
        run: |
          cd Testing/build
          
          echo "Checking output..."
          test "$(grep "FAILED" result.html | wc -l)" -eq 0
          test "$(grep "FAILED" result_transform_neon.html | wc -l)" -eq 0
          test "$(grep "FAILED" result_binaryf32_neon.html | wc -l)" -eq 0
          test "$(grep "FAILED" result_binary_complexf32_neon.html | wc -l)" -eq 0
          test "$(grep "FAILED" result_binaryf16_neon.html | wc -l)" -eq 0
          test "$(grep "FAILED" result_binary_complexf16_neon.html | wc -l)" -eq 0
          test "$(grep "FAILED" result_binaryq31_neon.html | wc -l)" -eq 0
          test "$(grep "FAILED" result_binary_complexq31_neon.html | wc -l)" -eq 0
          test "$(grep "FAILED" result_binaryq15_neon.html | wc -l)" -eq 0
          test "$(grep "FAILED" result_binary_complexq15_neon.html | wc -l)" -eq 0
          test "$(grep "FAILED" result_binaryq7_neon.html | wc -l)" -eq 0
          test "$(grep "FAILED" result_f16.html | wc -l)" -eq 0

