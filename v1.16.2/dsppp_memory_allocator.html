<!-- HTML header for doxygen 1.9.6-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CMSIS-DSP: Memory allocation</title>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="tabs.js"></script>
<script type="text/javascript" src="footer.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<script type="text/javascript" src="darkmode_toggle.js"></script>
<link href="extra_stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="extra_navtree.css" rel="stylesheet" type="text/css"/>
<link href="extra_search.css" rel="stylesheet" type="text/css"/>
<link href="extra_tabs.css" rel="stylesheet" type="text/css"/>
<link href="version.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../version.js"></script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 55px;">
  <td id="projectlogo" style="padding: 1.5em;"><a href="https://www.keil.arm.com/cmsis" target="_blank"><img alt="Logo" src="cmsis_logo_white_small.png"/</a></td>
  <td style="padding-left: 1em; padding-bottom: 1em;padding-top: 1em;">
   <div id="projectname">CMSIS-DSP
   &#160;<span id="projectnumber"><script type="text/javascript">
     <!--
     writeHeader.call(this);
     writeVersionDropdown.call(this, "CMSIS-DSP");
     //-->
    </script>
   </span>
   </div>
   <div id="projectbrief">CMSIS DSP Software Library</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
  <!--END !PROJECT_NAME-->
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<div id="CMSISnav" class="tabs1">
  <ul class="tablist">
    <script type="text/javascript">
      writeComponentTabs.call(this);
    </script>
  </ul>
</div>
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('dsppp_memory_allocator.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Memory allocation </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_src_memory_allocator"></a> By default, <code>malloc</code> is used.</p>
<div class="fragment"><div class="line">Vector&lt;float32_t,NB&gt;</div>
</div><!-- fragment --><p>is allocating a vector of dimension <code>NB</code> (known at build time) and datatype <code>float32_t</code>.</p>
<p>The definition of the <code>Vector</code> template is:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> P,</div>
<div class="line">         <span class="keywordtype">int</span> L=DYNAMIC,</div>
<div class="line">         <span class="keyword">template</span>&lt;<span class="keywordtype">int</span>&gt; <span class="keyword">typename</span> Allocator = TMP_ALLOC&gt;</div>
<div class="line"><span class="keyword">struct </span>Vector:Vector_Base&lt;P&gt;</div>
</div><!-- fragment --><p>It means that by default the memory allocator is <code>TMP_ALLOC</code>.</p>
<p>This <code>TMP_ALLOC</code> is a <code>#define</code> and can be changed if you define it before including any header from the library.</p>
<p>An allocator should implement a template like:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span>&lt;<span class="keywordtype">int</span> L&gt;</div>
<div class="line"><span class="keyword">struct </span>malloc_allocator {</div>
<div class="line">    <span class="comment">/* Dynamic dimension allocations (L&lt;0) */</span></div>
<div class="line">    <span class="keyword">static</span>  <span class="keywordtype">char</span>* allocate  ( vector_length_t sz) <span class="keyword">noexcept</span>;</div>
<div class="line">        </div>
<div class="line">    <span class="comment">/* Dimension L know at build time (L &gt; 0) */</span></div>
<div class="line">    <span class="keyword">static</span>  <span class="keywordtype">char</span>* allocate  ( ) noexcept;</div>
<div class="line">    </div>
<div class="line">    static <span class="keywordtype">void</span> destroy  ( <span class="keywordtype">char</span>* ptr ) noexcept;</div>
<div class="line">   </div>
<div class="line">};</div>
</div><!-- fragment --><p>It has no state because in practice we observed that compilers were generating more efficient code without state in the memory allocator template.</p>
<p>If you don't want to use a <code>malloc</code> based memory allocator, you can replace it with your own memory allocator and implement an API like the one just shown in <code>malloc_allocator</code>.</p>
<p>For instance, often in DSP pipelines, the dimensions of the vectors and matrixes are fixed and known at build time. In that case, you could replace the memory allocator by one using memory pools.</p>
<p>With memory pools, allocation is nearly cost free and there is no fragmentation.</p>
<p>The test framework of the library is providing an example in <code>allocator.h</code> and <code>allocator.cpp</code>.</p>
<p>There are two memory allocators:</p>
<ol type="1">
<li><code>stat_allocator</code> is a <code>malloc</code> based allocator that is making statistics on the memory allocations and how many buffers of each dimension is required</li>
<li><code>pool_allocator</code> can use the data generated by <code>stat_allocator</code>to pre-allocate memory pools that will be then used for the memory allocations. The memory pools are also creating aligned buffers.</li>
</ol>
<p>It is no more difficult (and less difficult) than allocating temporary buffers in CMSIS-DSP.</p>
<p>You could define the <code>TMP_ALLOC</code> with:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#if defined(POOL_ALLOCATOR)</span></div>
<div class="line"><span class="preprocessor">#define TMP_ALLOC pool_allocator</span></div>
<div class="line"><span class="preprocessor">#else </span></div>
<div class="line"><span class="preprocessor">#define TMP_ALLOC stat_allocator</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
</div><!-- fragment --><p>You use <code>stat_allocator</code> by default. When your code is working, you switch to <code>pool_allocator</code> to have better performance and determinism.</p>
<p>Another possibility is to use different vector types:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> P,<span class="keywordtype">int</span> L=arm_cmsis_dsp::DYNAMIC&gt;</div>
<div class="line"><span class="keyword">using </span>PVector = Vector&lt;P,L,pool_allocator&gt;;</div>
</div><!-- fragment --><p>Note that you cannot avoid using <code>TMP_ALLOC</code> because some functions in the library are creating temporary objects. For instance, if you want to make an identity matrix, you can use <code>mk_identity</code> that will make a memory allocation using <code>TMP_ALLOC</code></p>
<p>Also note that if you create a vector with:</p>
<div class="fragment"><div class="line">Vector&lt;float32_t&gt; v(NB);</div>
</div><!-- fragment --><p>then the dimension <code>NB</code> is a runtime parameter. The memory pool allocator given as example in this library is only working with dimensions known at build time. For runtime dimensions, it is still using a <code>malloc</code>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">
      <script type="text/javascript">
        <!--
        writeFooter.call(this);
        //-->
      </script>    
    </li>
  </ul>
</div>
</body>
</html>
